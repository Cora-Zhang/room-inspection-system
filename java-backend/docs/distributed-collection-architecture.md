# 分布式数据采集架构设计

## 1. 架构概述

### 1.1 设计目标

- **高性能**：支持200+设备并发采集，秒级数据更新
- **高可用**：分布式部署，支持故障自动转移
- **可扩展**：支持水平扩展，动态增减采集节点
- **容错性**：单节点故障不影响整体采集任务
- **负载均衡**：智能分配采集任务，均衡节点负载

### 1.2 架构层次

```
┌─────────────────────────────────────────────────────────┐
│                      Web管理端                             │
│              (任务配置、监控查看、告警管理)                 │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│                     API网关层                              │
│          (任务分发、结果汇总、负载均衡)                     │
└──────────────────────┬──────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        ▼              ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│  采集节点1    │ │  采集节点2    │ │  采集节点N    │
│  (Collector)  │ │  (Collector)  │ │  (Collector)  │
└──────┬───────┘ └──────┬───────┘ └──────┬───────┘
       │                │                │
       ▼                ▼                ▼
┌─────────────────────────────────────────────────────────┐
│                     监控设备层                             │
│  (SNMP设备、Modbus设备、BMS设备、传感器、门禁设备)        │
└─────────────────────────────────────────────────────────┘
```

## 2. 核心组件

### 2.1 采集节点（Collector）

采集节点是数据采集的核心组件，负责：

- 接收采集任务
- 执行数据采集
- 上传采集结果
- 心跳检测
- 故障恢复

**技术特性：**
- 支持多种监控协议（SNMP、Modbus、BMS等）
- 支持插件化扩展
- 支持断点续传
- 支持本地缓存

### 2.2 任务调度器（Task Scheduler）

任务调度器负责：

- 任务创建与分配
- 任务优先级管理
- 任务状态跟踪
- 任务失败重试
- 任务超时处理

**调度策略：**
- 基于负载的智能分配
- 基于地理位置的就近分配
- 基于协议类型的分组分配

### 2.3 协议适配器（Protocol Adapter）

协议适配器负责：

- 协议解析与封装
- 设备连接管理
- 数据转换
- 错误处理

**支持协议：**
- SNMP v1/v2c/v3
- Modbus TCP/RTU
- BMS接口
- 传感器网络协议
- 消防主机通信协议
- 自定义协议（插件）

### 2.4 数据汇聚器（Data Aggregator）

数据汇聚器负责：

- 数据接收与验证
- 数据清洗与转换
- 数据存储
- 实时数据推送

### 2.5 健康检查器（Health Checker）

健康检查器负责：

- 节点心跳检测
- 设备在线状态检测
- 采集任务健康检测
- 故障告警

## 3. 数据流程

### 3.1 采集任务流程

```
1. 任务创建
   └─> 管理员在Web端创建采集任务
   └─> 任务调度器接收任务请求
   └─> 任务入队

2. 任务分配
   └─> 任务调度器根据采集节点负载情况选择节点
   └─> 发送采集任务到选定的节点
   └─> 记录任务分配信息

3. 任务执行
   └─> 采集节点接收任务
   └─> 协议适配器连接设备
   └─> 执行数据采集
   └─> 数据转换与校验

4. 结果上报
   └─> 采集节点将采集结果发送到数据汇聚器
   └─> 数据汇聚器验证数据
   └─> 存储到数据库
   └─> 推送实时数据到Web端

5. 任务完成
   └─> 更新任务状态
   └─> 释放资源
```

### 3.2 故障处理流程

```
1. 节点故障检测
   └─> 健康检查器检测到节点心跳超时
   └─> 标记节点为离线状态

2. 任务重分配
   └─> 任务调度器检测到节点离线
   └─> 查找该节点上未完成的任务
   └─> 重新分配任务到其他节点

3. 故障恢复
   └─> 节点重启后自动注册
   └─> 任务调度器重新分配任务
```

## 4. 技术实现

### 4.1 消息队列

使用Redis Pub/Sub或RabbitMQ实现任务分发：

```java
// 任务发布
redisTemplate.convertAndSend("task:queue", task);

// 任务订阅
redisTemplate.subscribe((message, pattern) -> {
    // 处理采集任务
}, "task:queue");
```

### 4.2 负载均衡

基于Redis实现采集节点负载监控：

```java
// 节点负载上报
public void reportLoad(String nodeId, int currentTasks, int maxTasks) {
    String key = "collector:load:" + nodeId;
    Map<String, Object> loadInfo = new HashMap<>();
    loadInfo.put("currentTasks", currentTasks);
    loadInfo.put("maxTasks", maxTasks);
    loadInfo.put("timestamp", System.currentTimeMillis());
    loadInfo.put("status", "online");

    redisTemplate.opsForHash().putAll(key, loadInfo);
    redisTemplate.expire(key, 30, TimeUnit.SECONDS);
}

// 负载最低的节点
public String getLowestLoadNode() {
    Set<String> nodeIds = redisTemplate.keys("collector:load:*");
    // 比较各节点负载，返回最低负载节点
}
```

### 4.3 心跳检测

```java
// 节点心跳
@Scheduled(fixedRate = 5000) // 每5秒发送一次
public void sendHeartbeat() {
    String key = "collector:heartbeat:" + nodeId;
    redisTemplate.opsForValue().set(key, System.currentTimeMillis(), 30, TimeUnit.SECONDS);
}

// 心跳检测
@Scheduled(fixedRate = 10000) // 每10秒检测一次
public void checkHeartbeat() {
    Set<String> nodeIds = redisTemplate.keys("collector:heartbeat:*");
    for (String nodeId : nodeIds) {
        Long lastHeartbeat = redisTemplate.opsForValue().get(nodeId);
        if (lastHeartbeat == null || System.currentTimeMillis() - lastHeartbeat > 30000) {
            // 标记节点离线
            markNodeOffline(nodeId);
        }
    }
}
```

## 5. 性能优化

### 5.1 采集策略

- **批量采集**：支持一次采集多个设备或指标
- **优先级采集**：重要设备优先采集
- **差异化频率**：根据设备重要性设置不同采集频率
- **动态调整**：根据网络状况动态调整采集频率

### 5.2 数据缓存

- **本地缓存**：采集节点本地缓存最近数据
- **Redis缓存**：热点数据缓存到Redis
- **预加载**：提前加载历史数据用于对比

### 5.3 并发控制

```java
// 限制单个节点的最大并发任务数
private final Semaphore semaphore = new Semaphore(100);

public void executeTask(CollectionTask task) {
    if (semaphore.tryAcquire()) {
        try {
            // 执行采集任务
            doCollect(task);
        } finally {
            semaphore.release();
        }
    } else {
        // 节点负载过高，拒绝任务
        rejectTask(task);
    }
}
```

## 6. 部署架构

### 6.1 单机房部署

```
┌─────────────────────────────────────────────────┐
│              负载均衡器（Nginx）                  │
└──────────────┬──────────────────────────────────┘
               │
        ┌──────┴──────┬──────┴──────┐
        ▼             ▼             ▼
┌───────────┐  ┌───────────┐  ┌───────────┐
│ 后端服务1  │  │ 后端服务2  │  │ 后端服务3  │
└─────┬─────┘  └─────┬─────┘  └─────┬─────┘
      │             │             │
      └─────────────┼─────────────┘
                    ▼
          ┌─────────────────┐
          │    Redis集群     │
          └────────┬────────┘
                   │
        ┌──────────┼──────────┐
        ▼          ▼          ▼
┌──────────┐ ┌──────────┐ ┌──────────┐
│ 采集节点1 │ │ 采集节点2 │ │ 采集节点3 │
└──────────┘ └──────────┘ └──────────┘
```

### 6.2 多机房部署（跨地域）

```
┌─────────────────┐        ┌─────────────────┐
│   北京机房       │        │   上海机房       │
│ ┌─────────────┐ │        │ ┌─────────────┐ │
│ │ 采集节点群  │ │        │ │ 采集节点群  │ │
│ └──────┬──────┘ │        │ └──────┬──────┘ │
└────────┼────────┘        └────────┼────────┘
         │                           │
         └───────────┬───────────────┘
                     │
         ┌───────────▼───────────────┐
         │   IPsec VPN 通信链路      │
         └───────────┬───────────────┘
                     │
         ┌───────────▼───────────────┐
         │    数据汇聚中心（总部）    │
         │  ┌───────────────────┐    │
         │  │  MySQL主从集群     │    │
         │  │  Redis集群         │    │
         │  └───────────────────┘    │
         └───────────────────────────┘
```

## 7. 监控指标

### 7.1 节点监控

- 节点在线状态
- 节点负载（CPU、内存、网络）
- 当前任务数
- 采集成功率
- 采集延迟

### 7.2 任务监控

- 任务执行状态
- 任务执行时间
- 任务失败率
- 任务重试次数

### 7.3 设备监控

- 设备在线状态
- 设备采集成功率
- 数据采集延迟
- 数据丢失率

## 8. 告警策略

### 8.1 节点告警

- 节点离线告警
- 节点负载过高告警
- 采集失败率过高告警

### 8.2 任务告警

- 任务执行超时告警
- 任务连续失败告警

### 8.3 设备告警

- 设备离线告警
- 采集数据异常告警
- 数据丢失告警

## 9. 容灾方案

### 9.1 数据备份

- 定时备份数据库
- Redis持久化（AOF + RDB）
- 采集日志备份

### 9.2 故障恢复

- 自动故障转移
- 任务自动重分配
- 数据自动同步

### 9.3 灾难恢复

- 异地灾备中心
- 数据定期同步
- 定期灾难恢复演练
